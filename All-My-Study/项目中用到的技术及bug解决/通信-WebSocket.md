### WebSocket

##### 1. 原理

* WebSocket是一个基于HTTP协议改进的，握手阶段依赖于HTTP，握手验证之后就完全装维WebSocket了
* 首先要知道HTTP协议不管1.0还是1.1都是无状态的，不支持长连接的，每次一个request都只能够返回一个response，
* 所以一般采用ajax轮询的方式，在无业务时，浏览器不断的发起request并一直不断的接收服务器的response，无论有无新消息，都返回response，这需要服务器有很快的**处理速度和资源**，比较多的占用了服务器的资源
* 再则使用long poll，和ajax轮询差不多，不过其采用的是阻塞模型，发起一个request，若一直收不到服务器的更新消息response就一直不关闭，知道收到更新消息，这需要服务器有**高并发**，能够同时接收较多的用户
* 使用了websocket这个更改过后的TCP连接协议，所建立的连接就是一个**长连接**，在连接一次之后，浏览器和服务器之间就可以不需要建立连接的多次发送数据，一般用于服务器多次发数据到客户端

##### 2. 解决问题

* 解决了HTTP不能够用与长连接的实现问题，
* 能够较少的占用服务器的资源来实现长连接

##### Nginx

* 一般前端使用Nginx来进行反向代理，所以现在一般建立连接都是由Nginx来进行维护，若有消息之后，在有后端服务器将信息发送给Nginx，再经由此发到用户手中。
* 使用WebSocket可以大大减少后端服务器的压力，其只需要在有新消息推送时参与到数据的传输

##### 与TCP连接的坑

* 一般建立长连接之后，其发送数据的过程中，并不是直接由服务器到达客户端，其相比于HTTP的短连接少了每次的握手和验证
* 每次发送数据时，都需要经过无数的数据链路，其中包括路由和防火墙等中间路线，其中也可以会导致连接计入未中断但数据不能够发送的情况，因为中间链路停止了发送并且也没有发送FIN来通知两边进行再连接或中断连接