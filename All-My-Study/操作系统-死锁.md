### 死锁

##### 1. 死锁产生的必要条件

* 互斥：资源对于进程而言是互斥的，其只能被一个进程获得
* 占有和等待：已经占有某个资源的进程能够再次申请新的资源
* 不可抢占：已经被分配给一个进程的资源不能够被其他进程强制的占有
* 环路等待：有两个或两个以上的进程组成了一条环路，环路上的每个进程都在等待下一个进程占有的资源

##### 2. 死锁的处理方法

1. **鸵鸟策略**
   
   * 对于死锁，在发现之后处理需要消耗巨量的资源，所以现在大多现行的操作系统Unix，Linux，Windows在产生死锁之后都是采用鸵鸟策略，对死锁视而不见，进行忽略。
   
2. **死锁检测和死锁恢复**：在死锁发生后进行检测和恢复

   1. 死锁检测

      ![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/b1fa0453-a4b0-4eae-a352-48acca8fff74.png)

      * 对每种类型一个资源的死锁检测：对于一个资源，其一次只能被一个进程所占有，如上图，在进程进行资源抢占中出现了环，图b。则满足了死锁出现的必要条件。通过对一个节点的进程进行标记，并对其后的所有节点进行深度优先搜索，若再次找到了标记的节点则说明发生了死锁。

      ![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e1eda3d5-5ec8-4708-8e25-1a04c5e11f48.png)

      * 每种类型多个资源的死锁检测：一个进程需要多个资源才能够进入运行状态，对进程进行标记，若最后有进程没有被标记，则没被标记的进程都产生了死锁
   
   2. 死锁恢复
   
      * 利用资源抢占进行恢复
      * 利用回滚进行恢复，即释放现有进程占有的资源
      * 通过杀死进程恢复
   
3. **死锁预防**： 在程序运行之前对死锁进行预防，一般都才有此方法

   * 破坏互斥条件：资源不再互斥
   * 破坏占有和等待条件：进程在运行之前必须拿到所有的需要的资源
   * 破坏不可抢占条件：资源可以被进程强制抢占
   * 破坏环路等待：对资源统一编号，进程只能按编号顺序来请求资源

##### 3. 死锁避免

* 在程序运行时避免发生死锁

* **安全状态**

  ![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ed523051-608f-4c3f-b343-383e2d194470.png)

  

  图 a 的第二列 Has 表示已拥有的资源数，第三列 Max 表示总共需要的资源数，Free 表示还有可以使用的资源数。从图 a 开始出发，先让 B 拥有所需的所有资源（图 b），运行结束后释放 B，此时 Free 变为 5（图 c）；接着以同样的方式运行 C 和 A，使得所有进程都能成功运行，因此可以称图 a 所示的状态时安全的。

  定义：如果没有死锁发生，并且即使所有进程突然请求对资源的最大需求，也仍然存在某种调度次序能够使得每一个进程运行完毕，则称该状态是安全的。

  安全状态的检测与死锁的检测类似，因为安全状态必须要求不能发生死锁。下面的银行家算法与死锁检测算法非常类似，可以结合着做参考对比。

* **单个资源的银行家算法**

  一个小城镇的银行家，他向一群客户分别承诺了一定的贷款额度，算法要做的是判断对请求的满足是否会进入不安全状态，如果是，就拒绝请求；否则予以分配。

  ![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/d160ec2e-cfe2-4640-bda7-62f53e58b8c0.png)

  

  上图 c 为不安全状态，因此算法会拒绝之前的请求，从而避免进入图 c 中的状态。

* **多个资源的银行家算法**

  ![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/62e0dd4f-44c3-43ee-bb6e-fedb9e068519.png)

  

  上图中有五个进程，四个资源。左边的图表示已经分配的资源，右边的图表示还需要分配的资源。最右边的 E、P 以及 A 分别表示：总资源、已分配资源以及可用资源，注意这三个为向量，而不是具体数值，例如 A=(1020)，表示 4 个资源分别还剩下 1/0/2/0。

  检查一个状态是否安全的算法如下：

  - 查找右边的矩阵是否存在一行小于等于向量 A。如果不存在这样的行，那么系统将会发生死锁，状态是不安全的。
  - 假若找到这样一行，将该进程标记为终止，并将其已分配资源加到 A 中。
  - 重复以上两步，直到所有进程都标记为终止，则状态时安全的。

  如果一个状态不是安全的，需要拒绝进入这个状态。

   

   

